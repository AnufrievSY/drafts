# MSWorker

Репозиторий для всевозможных решений связанных с автоматизацией работы в Моем складе

## Структура проекта

```plaintext
MSWorker/
├── api/                            # Скрипты для работы с Мой склад
│   ├── meta_data/                  # Папка с метаданными
│   │   └── ...
│   ├── templates/                  # Папка с шаблонами для отправки в чат
│   │   └── ...
│   ├── __init__.py                 # Инициализация работы с Мой склад
│   ├── Exceptions.py               # Модуль с кастомными ошибками
│   ├── meta_worker.py              # Скрипт отвечающий за поиск всевозможных метаданных
│   ├── возвраты.py                 # Скрипт для создания возвратов
│   ├── заказ.py                    # Скрипт для создания заказа (по-умолчанию для авито)
│   ├── оприходование.py            # Скрипт для создания оприходования
│   ├── остатки.py                  # Скрипт отвечающий за скачивание остатков на складе
│   ├── отгрузка.py                 # Скрипт отвечающий за создание отгрузки
│   ├── отчистка.py                 # Скрипт отвечающий за отчистку распроведенных заказов
│   ├── перемещение.py              # Скрипт для создания перемещений
│   ├── приемки.py                  # Скрипт отвечающий за обновление базы товаров
│   ├── списание.py                 # Скрипт для создания списания
│   └── товар.py                    # Скрипт отвечающий за обновление товара
├── bot_commands/                   # Команды TG-бота
│   ├── __init__.py                 # Инициализация пакета для работы с метаданными
│   ├── bot_make_enter.py           # Команда для создания задачи оприходования
│   ├── bot_make_loss.py            # Команда для создания задачи списания
│   ├── bot_make_move.py            # Команда для создания задачи перемещения
│   ├── bot_make_order.py           # Команда для создания задачи заказа
│   └── bot_make_return.py          # Команда для создания задачи возврата
├── downloads/                      # Папка куда скачиваются файлы полученные через бота
│   └── ...
├── old_versions/                   # Архив старых версий проекта
│   └── ...
├── resources/                      # Ресурсы и конфигурационные файлы
│   ├── config.py                   # Основной файл конфигурации
│   └── settings.yml                # Настройки проекта в формате YAML
├── temp/                           # Временные файлы и данные
│   └── ...
├── utils/                          # Утилитарные скрипты и вспомогательные функции
│   ├── requests/
│   │   ├── err_handler.py          # Обработчик ошибок запросов
│   │   ├── requests_.py            # Модуль асинхронных запросов
│   └── logging_.py                 # Модуль для логирования и прогресс бар
├── .gitignore                      # Список того, что Git надо игнорировать
├── errors.log                      # Логи ошибок
├── log.txt                         # Файл для логирования команд полученных через TG-бота
├── README.md                       # Документация проекта
├── task_manager.py                 # Менеджер задач для работы с полученными через TG-бот операциями
├── tasks.json                      # Файл с заданиями. Из него task_manager берет задачи, удаляя текущую.
└── tg_bot.py                       # Основной скрипт TG-бота
```

---

## Основные скрипты

| команда `bot_commands` | функция `api`      |
|------------------------|--------------------|
| `bot_make_order.py`    | `заказ.py`         |
| `bot_make_enter.py`    | `оприходование.py` |
| `bot_make_move.py`     | `перемещение.py`   |
| `bot_make_loss.py`     | `списание.py`      |
| `bot_make_return.py`   | `возвраты.py`      |

Для данных скриптов логика работы одинаковая. Отличаются только переменные.

Если код отработал успешно, вернет ссылку на операцию в Мой склад. Если нет, то в `result` можно получить 
краткую информацию о том, что пошло не так, а в логи ошибок запишется как запрос, так и полная трассировка ошибки.
Посмотреть или изменить структуру `result` можно в `api.__init__.py`

Внутри есть две функции:

- `get_component` - отвечает за получение метаданных на основании кода товара. Если товар ранее запрашивался, его
  метаданные хранятся в файле `../api/meta_data/items.pkl` иначе происходит запрос к Мой склад.
- `run` - отвечает за отработку команды.

## Вспомогательные скрипты

### `meta_worker.py`

Скрипт для поиска всевозможных метаданных в Моем складе. Если данные были скачаны ранее, то запрос
осуществляться не будет, а данные будут получены из соответствующего .pkl файла лежащего в `../MSWorker/api/meta_data`.
Если же данные найти не удалось, то осуществиться запрос на получение соответствующего класса метаданных, а файл
с ними перезапишется.

### `остатки.py`

`вызывается другими скриптами api`
Скрипт отвечающий за скачивание остатков из Мой склад. Реализованна через кастомный async requests.  
Внутри есть две функции:

- `by_warehouse` - отвечает за скачивание остатков с переданного склада. Требует на вход точное название склада, как в
  настройках Мой склад. Самостоятельно ищет его метаданные для запросов. По-умолчанию запрос на получение остатков
  возвращает максимум 1000 строк, далее необходимо делать смещение.
  Данная функция самостоятельно определяет сколько еще запросов необходимо сделать, чтобы скачать все остатки.
- `result_prepare` - в рамках данного проекта реализованна дополнительная подготовка данных - замена минусовых остатков
  на 0, а также обрезка данных до двух колонок: артикул и свободный остаток. А также реализованно сохранение исходных
  данных в `temp` папку если уровень логирования == `DEBUG`.

### `отчистка.py`

Скрипт для отчистки распроведенных заказов. Запускается по таймеру указанному в `task_manager.py`. Также высылает 
результаты в чат разработчиков.

### `приемки.py`

Скрипт отвечающий за получение приемок. На текущий момент выполняет обновление закупочных цен в Мой склад.

### `товар.py`

Скрипт для обновления карточки товара. На данный момент обновляет только закупочные цены на основании последних приемок.
Запускается по таймеру указанному в `task_manager.py`. Также высылает результаты в чат разработчиков.

---

## Как работать

Основные скрипты `tg_bot.py` и `task_manager.py`. Их необходимо открыть через PyCharm, убедится что в верхнем правом
углу рядом с кнопкой запуска `▶` выбран `Current File` (текущий файл) и нажать на кнопку запуска (`CTRL+F10`).

Если скрипт выполняется в данный момент, то вы увидите как раз эти два исполняющихся файла. Нажимаем на прекращение
исполнения (`CTRL + F2`) и снова запуск.

### Настройки

За настройки проекта отвечает файл `settigs.yml` в нем допускается изменение только значений (самых дочерних элементов).
При изменении ключей, изменении логики расположения или добавлении нового, требуется в файле `config.py` внести
соответствующие изменения.

---

## Как работать с ошибками

В большинстве случаев ошибки лечатся простым перезапуском программы описанной в пункте выше. Все остальные ошибки
записываются в файл `errors.txt` где подробно описано когда, где и что произошло, с выводом полной информации ошибки.  
**Например**, следующая запись:

```plaintext
ERROR    | 29-11-2024 02:18:20.611611 | 311 ..\tg_bot.py | HTTPSConnectionPool(host='api.telegram.org', port=443): Read timed out. (read timeout=25)
```

**Обозначает**:

- `ERROR` - уровень ошибки (`CRITICAL` еще хуже, но вряд ли встретится)
- `29-11-2024` - дата возникновения ошибки, в формате день-месяц-год
- `02:18:20.611611` - время возникновения ошибки, в формате час-минута-секунда-миллисекунды
- `311` - строка в который вызвалась ошибка
- `..\tg_bot.py` - файл в котором возникла ошибка
- `HTTPSConnectionPool(host='api.telegram.org', port=443): Read timed out. (read timeout=25)` - описание возникшей
  ошибки
